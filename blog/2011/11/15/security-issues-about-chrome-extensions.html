<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width; initial-scale=1.0">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Google Chromeエクステンションのセキュリティ確保</title>

    <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">
    <link href="/favicon.png" rel="icon" type="image/png">
    <link href="/stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <script type="text/javascript" async="" src="http://www.google-analytics.com/ga.js"></script>
    <script src="/javascripts/modernizr-2.0.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-26982762-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="blog blog_2011 blog_2011_11 blog_2011_11_15 blog_2011_11_15_security-issues-about-chrome-extensions">
  <header>
    <hgroup>
      <a href="/"><h1 class="title">K2NR.ME</h1></a>
    </hgroup>
  </header>
  <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja">Tweet</a>
    <article>
    <header>
      <h1>Google Chromeエクステンションのセキュリティ確保</h1>
      <time datetime="2011-11-15" pubdate>Nov 15, 2011</time>
    </header>
    <p>さて、ずいぶんと日が経ちましたが<a href="https://chrome.google.com/webstore/detail/gghkfhpblkcmlkmpcpgaajbbiikbhpdi">Vichrome</a>にセキュリティの脆弱性があるとのご報告を頂きました。</p>

<p><a href="http://twitter.com/#!/teramako/status/127357023242289154">http://twitter.com/#!/teramako/status/127357023242289154</a></p>

<p>つまり、コンテンツに要素を追加すると、コンテンツ側のスクリプトがその要素に対してアクセスできてしまうわけです。
Chrome Extensionとセキュリティというのは、以前から議論されている話ではありますが、エクステンションの開発者を含めて一般的に浸透されているとは言い難い状況なので簡単にまとめておきます。
まずはChrome Extensionはどのような仕組みなのかから始めましょう。</p>

<h2 id="chrome-extensionってどうやってできてるの？">Chrome Extensionってどうやってできてるの？</h2>

<p>一般的なChrome Extensionは主に3つのコンポーネントから構成されていて、それは<a href="http://code.google.com/chrome/extensions/content_scripts.html">Content Script</a>と<a href="http://code.google.com/chrome/extensions/background_pages.html">Background page</a>とActions（<a href="http://code.google.com/chrome/extensions/browserAction.html">Browser Actions</a>、<a href="http://code.google.com/chrome/extensions/pageAction.html">Page Actions</a>）です。</p>

<h3 id="content-script">Content Script</h3>

<p><a href="http://code.google.com/chrome/extensions/content_scripts.html">Content Script</a>とはページに直接埋め込まれるスクリプトで、ページのDOM要素に直接アクセスすることができます。
<code>window</code>や<code>document</code>といったグローバルオブジェクトにもアクセス可能で、使用する分には通常のコンテンツ側のスクリプトと何ら変わりありません。</p>

<p><em>Content Script</em>はいわゆる<em>Isolated World</em>と呼ばれるChrome Extension独自の空間で動作しており、コンテンツ側のスクリプトからは見えず、Extensionの<em>Content Script</em>とコンテンツ側のスクリプトは相互アクセス不可になってます。当然これはセキュリティを確保するための仕組みです。双方が共通してアクセスできる場所というのがコンテンツのDOM要素であって、多くのChrome Extensionのセキュリティ問題はDOM要素の不適切な使用に起因します。（冒頭のVichromeのバグも）</p>

<h3 id="background-page">Background page</h3>

<p><a href="http://code.google.com/chrome/extensions/background_pages.html">Background Page</a>とはエクステンション専用のページで、見た目には一切現れず裏でコソコソと動いてます。こいつの特徴は</p>

<ul>
<li>完全に独立したプロセスとして動作している</li>
<li>Chrome ExtensionのAPIを通じて各<em>Content Script</em>と通信できる</li>
<li>多くのChrome Extension APIは<em>Bacground Page</em>からしかアクセス出来ない</li>
<li>エクステンション専用の<code>localStorage</code>を持っている</li>
</ul>

<p>逆に言えばこれらの特徴を必要としないExtensionは<em>Background Page</em>を持つ必要はありません。</p>

<h3 id="actions">Actions</h3>

<p><a href="http://code.google.com/chrome/extensions/browserAction.html">Browser Actions</a>と<a href="http://code.google.com/chrome/extensions/pageAction.html">Page Actions</a>があります。</p>

<p>Chromeの右上にExtensionのアイコンがありますね。あれです。あれをクリックするとポップアップが表示されますよね。あのHTMLに埋め込まれたJavascriptもExtensionの一部なので<em>Background Page</em>と通信することができます。</p>

<h2 id="何がセキュリティ上の脅威となりうるのか">何がセキュリティ上の脅威となりうるのか</h2>

<p>本題です。
Chrome Extensionのセキュリティに関しては幾つか文書があって</p>

<ol>
<li><a href="http://blog.chromium.org/2011/07/writing-extensions-more-securely.html">http://blog.chromium.org/2011/07/writing-extensions-more-securely.html</a></li>
<li><a href="http://oxdef.info/papers/ext/chrome.html">http://oxdef.info/papers/ext/chrome.html</a></li>
</ol>

<p>こういったところを読めば大体理解できると思います。しかし英語なので、ここでかいつまんで説明します。</p>

<h3 id="xss">XSS</h3>

<p>Extensionであっても<em>XSS</em>の危険がありますよ、という話です。通常の<em>XSS</em>とは違っているのは、ページ自体には脆弱性がなかったとしても、Extensionが脆弱性になってしまうということです。
では何が脅威となるのかといえば、それは外部からやってくるデータとページのコンテンツそれ自身です。上記の2.の例だとメールの件名などですね。
<em>XSS</em>には色々なバリエーションが考えられますが、防ぐための手段は至ってシンプルです：</p>

<ul>
<li>Extensionに余計なパーミッションは与えない</li>
<li><code>eval()</code>は使うな</li>
<li>外からやって来るデータとリードするページコンテンツのデータはきちんとチェックして脅威を取り除きましょう。</li>
</ul>

<h3 id="extensionがdom要素を埋め込む場合">ExtensionがDOM要素を埋め込む場合</h3>

<p>ここからは上記の文書には書かれていない話。</p>

<p>例えばVichromeのようにユーザに何らかの入力を求める場合、コンテンツに<code>&lt;INPUT&gt;</code>要素を埋め込む以外に方法はありません。（非常に限定された用途であればPage|Browser Actionでも実現可能ですが）</p>

<p>ここで大事なのはExtensionが自分で埋め込んだDOM要素であってもページ側のコンテンツによって改ざんされている可能性があるということです。そして厄介なのは、この場合、入力をエスケープしたりあるいはその他の方法で脅威を取り除くことができないことです。</p>

<p>つまり、悪意ある改ざんの結果、正規の、完璧に正しいVichromeコマンドに入力が変更されている可能性があるのです。
これを防ぐにはXSSの項で挙げた方法では全く役に立ちません。そもそも改ざんの可能性自体を潰す必要があります。これは大変です。繰り返しますが、実現するためにはコンテンツに<code>&lt;INPUT&gt;</code>要素を埋め込む以外に方法はありません。そして埋め込まれた要素はすべからくコンテンツ側からアクセス可能です。</p>

<p>さて、どうすればよいでしょう。</p>

<h3 id="解決策">解決策</h3>

<p>先に述べます。正解は<code>&lt;iframe&gt;</code>です。</p>

<p><code>&lt;iframe&gt;</code>のsrcが異なるドメインの場合、親コンテンツからフレーム内のコンテンツにアクセスすることはできません。
これを利用して、埋め込む要素を<code>&lt;iframe&gt;</code>内に移動させます。具体的には</p>

<ol>
<li>Extension自身が入力用のhtmlファイルを保持する。このファイルは<code>chrome-extension://[extension id]/...</code>というURIに位置します。</li>
<li>1.のhtmlファイルをsrcとする<code>&lt;iframe&gt;</code>要素を親コンテンツに埋め込む</li>
</ol>

<p>これでコンテンツ側のスクリプトから入力を改ざんすることはできなくなりました。</p>

<p>しかしここで更なる問題に直面します。<strong>親コンテンツからアクセス出来ないということは、当然親コンテンツに埋め込まれたExtensionのContent Scriptからもiframe内の要素にアクセスできません。</strong></p>

<p>しかしながら幸いなことに、<strong>chrome-extension://[extension id]/ドメインからであれば、ExtensionのBackground Pageと通信することができます。</strong>（ちなみにこの仕様、<a href="http://code.google.com/chrome/extensions/docs.html">公式のドキュメント</a>のどこにも記載されていないような気がします）</p>

<p>これでゴールが見えましたね。</p>
<pre class="highlight plaintext"><code>親コンテンツのContent Script ⇔ Background Page ⇔ 入力用iframe
</code></pre>

<p>このように<em>Background Page</em>がコンテンツとiframeの間に入ることで間接的に親コンテンツの<em>Content Script</em>とiframeが通信することができます。</p>

<p>ご想像の通り、大変にめんどくさいです。今までは</p>
<pre class="highlight plaintext"><code>// JQuery使った場合
var val = $('#vichrome-box').val();
</code></pre>

<p>などとすれば、たった1行で目的の要素にアクセスして値を取得することができたのに、この修正案では非同期のメッセージ交換が4回も行う必要があり、種々のタイミング制御などなど非同期通信独特の処理を実施する必要があります。ですので、入力を求めるような機能を実装をする場合はまず</p>

<ul>
<li>その機能本当に必要？</li>
<li>必要だったとして、入力のインタフェースはBrowser|Page Actionsのポップアップに移せないの？</li>
</ul>

<p>という質問を投げかけた上で、それでも必要な場合は上記の<code>&lt;iframe&gt;</code>を用いた対策を施されてはいかがでしょう。</p>

<h2 id="最後に">最後に</h2>

<p>どうでしょうか。セキュリティを強固に保とうとすると、一部のExtensionは多大な労力を必要とすることがご理解頂けたかと思います。</p>

<p>ちなみに、Vichromeと同タイプのユーザーに何かしらの入力を求めて処理を実行するようなExtensionの多くがこの対策を行えておらず、潜在的にセキュリティバグを抱えています。あえて名前は挙げませんが、皆様どうぞご注意を。</p>

<p>個人的な見解としては、本来このようなセキュリティの対策をアプリケーション側で施すことには抵抗があります。
3度目ですが、現状ではユーザに何らかの入力を求める場合、コンテンツに<code>&lt;INPUT&gt;</code>要素を埋め込む以外に方法はありません。
このような機能を持つExtensionのために入力用のAPIなど提供して頂ければとGoogle様には切に願う次第であります。</p>

  </article>
  
  <div id="disqus_thread"></div>
  <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'k2nrme'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  <footer>
  k2nr
</footer>

  </body>
</html>
