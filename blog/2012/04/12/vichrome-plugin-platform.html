<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width; initial-scale=1.0">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Vichromeにプラグイン機能を実装してみました</title>

    <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">
    <link href="/favicon.png" rel="icon" type="image/png">
    <link href="/stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <script type="text/javascript" async="" src="http://www.google-analytics.com/ga.js"></script>
    <script src="/javascripts/modernizr-2.0.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-26982762-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="blog blog_2012 blog_2012_04 blog_2012_04_12 blog_2012_04_12_vichrome-plugin-platform">
  <header>
    <hgroup>
      <a href="/"><h1 class="title">K2NR.ME</h1></a>
    </hgroup>
  </header>
  <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja">Tweet</a>
    <article>
    <header>
      <h1>Vichromeにプラグイン機能を実装してみました</h1>
      <time datetime="2012-04-12" pubdate>Apr 12, 2012</time>
    </header>
    <p>いつか実装しようと思ってたので、開発に着手しました。
VichromeにプラグインをインストールしてVichromeを拡張する機能です。</p>

<p>とりあえずまだアルファもアルファで設定画面とか超しょぼいしバグも多いですが、こんなもの作ってるよという報告だけしておきます。</p>

<p>ソースコードはブランチ作って<a href="https://github.com/k2nr/ViChrome/tree/plugin-platform">githubで公開しています</a>。興味のある人はcloneして実際に使ってみてください。</p>

<p>以下簡単に使い方のイメージとプラグインの開発方法について説明します。(ここで紹介する内容は将来的に変更される可能性が高いです。あくまでも実験的実装の紹介としてお読みください)</p>

<h2 id="使い方">使い方</h2>

<p><a href="https://github.com/k2nr/vichrome-plugins">githubにサンプルプラグインを公開しています</a>。</p>

<p>僕の普段の生活に欠かせないWEBサービス、<a href="http://grooveshark.com/">GrooveShark</a>の操作をVichrome経由で行うプラグインを作ってみました。</p>

<p>この<strong>GrooveShark Controller</strong>を使ってみましょう。上記のレポジトリをcloneしておいてください。
VichromeのオプションページからPluginsタブを開いて、「gscontroller.zip」を選び「Add New Plugin」ボタンをクリックします。
UIがしょぼすぎて何のリアクションもかえってきませんが、これでプラグインが追加されました。</p>

<p>まずGrooveSharkを開いて適当にお気に入りの曲を再生しておいてください。
次に新しいタブで適当なページを開いてVichromeのコマンドボックスを開き「GrooveSharkPlayStop」コマンドを実行します。
すると、GrooveSharkで再生中の曲が停止します。</p>

<p>このプラグインで追加されるコマンドは全部で3つ。</p>

<ul>
<li>GrooveSharkPlayStop</li>
<li>GrooveSharkNext</li>
<li>GrooveSharkPrevious</li>
</ul>

<p>機能はコマンド名が示すとおりです。
あとは適当なキーにコマンドをmapすれば夢のGrooveShark人生が待っています。</p>

<h2 id="作り方">作り方</h2>

<p>プラグインは3つのファイルで構成されます。これら3ファイルをzipで圧縮したものがプラグインファイルです。</p>

<h3 id="manifest-json">manifest.json</h3>

<p>manifest.jsonはプラグインの名前、概要、その他メタ情報をJSON形式で記述するファイルです。</p>
<pre class="highlight javascript"><code><span class="p">{</span>
    <span class="s2">"name"</span><span class="err">:</span> <span class="s2">"GrooveShark Controller"</span><span class="p">,</span>
    <span class="s2">"description"</span><span class="err">:</span> <span class="s2">"Controlls GrooveShark Player"</span>
<span class="p">}</span>
</code></pre>

<p>現状ではname,description以外の要素は無視されます。</p>

<h3 id="contentscript-js">contentscript.js</h3>

<p>Chrome ExtensionのContent Script上で動作するコードはcontentscriptに記述します。</p>
<pre class="highlight javascript"><code><span class="nx">vichrome</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">addCommand</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"GrooveSharkPlayStop"</span><span class="p">,</span>
    <span class="na">triggerType</span><span class="p">:</span> <span class="s2">"sendToBackground"</span>
<span class="p">});</span>
<span class="nx">vichrome</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">addCommand</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"GrooveSharkNext"</span><span class="p">,</span>
    <span class="na">triggerType</span><span class="p">:</span> <span class="s2">"sendToBackground"</span>
<span class="p">});</span>
<span class="nx">vichrome</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">addCommand</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"GrooveSharkPrevious"</span><span class="p">,</span>
    <span class="na">triggerType</span><span class="p">:</span> <span class="s2">"sendToBackground"</span>
<span class="p">});</span>
</code></pre>

<p>GrooveShark Controllerではすべての機能をBackground Page上で動作させるためコマンドだけ登録して、コマンドをそのままBackground Pageに送るという指定だけしてます。</p>

<h3 id="background-js">background.js</h3>

<p>Chrome ExtensionのBackground Page上で動作するコードはこっちに書きます。</p>
<pre class="highlight javascript"><code><span class="nx">execute</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">getAllInWindow</span><span class="p">(</span> <span class="kc">null</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tabs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">tab</span> <span class="o">=</span> <span class="nx">tabs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span><span class="p">(</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span> <span class="sr">/grooveshark</span><span class="se">\.</span><span class="sr">com/</span> <span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">chrome</span><span class="p">.</span><span class="nx">tabs</span><span class="p">.</span><span class="nx">sendRequest</span><span class="p">(</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
                    <span class="na">command</span><span class="p">:</span> <span class="s2">"ExecuteScript"</span><span class="p">,</span>
                    <span class="na">code</span><span class="p">:</span> <span class="nx">code</span>
                <span class="p">});</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nx">vichrome</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">addCommand</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"GrooveSharkPlayStop"</span><span class="p">,</span>
    <span class="na">func</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">execute</span><span class="p">(</span><span class="s1">'$("button#player_play_pause").click()'</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">vichrome</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">addCommand</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"GrooveSharkNext"</span><span class="p">,</span>
    <span class="na">func</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">execute</span><span class="p">(</span><span class="s1">'$("button#player_next").click()'</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">vichrome</span><span class="p">.</span><span class="nx">plugins</span><span class="p">.</span><span class="nx">addCommand</span><span class="p">({</span>
    <span class="na">name</span><span class="p">:</span> <span class="s2">"GrooveSharkPrevious"</span><span class="p">,</span>
    <span class="na">func</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">execute</span><span class="p">(</span><span class="s1">'$("button#player_previous").click()'</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>

<p>まだ全然情報が整理されてなくてアレですが、そのうちプラグイン開発者用のドキュメントなんかも整理していきたいですね。</p>

<p>あ、そうそう。<a href="http://www.amazon.co.jp/registry/wishlist/3RAOAVXS8DJUV">乞食リスト</a>まだまだ受け付けてます。なんかくれたらもっとばんばります。</p>

  </article>
  
  <div id="disqus_thread"></div>
  <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'k2nrme'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  <footer>
  k2nr
</footer>

  </body>
</html>
