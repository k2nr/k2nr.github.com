<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width; initial-scale=1.0">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>HerokuでClojureアプリをCompojureを使ってデプロイしてみよう その1</title>

    <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Fjalla+One" rel="stylesheet" type="text/css">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">
    <link href="/favicon.png" rel="icon" type="image/png">
    <link href="/stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <script type="text/javascript" async="" src="http://www.google-analytics.com/ga.js"></script>
    <script src="/javascripts/modernizr-2.0.js"></script>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-26982762-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="blog blog_2012 blog_2012_03 blog_2012_03_22 blog_2012_03_22_deploy-clojure-app-on-heroku-with-clojure-1">
  <header>
    <hgroup>
      <a href="/"><h1 class="title">K2NR.ME</h1></a>
    </hgroup>
  </header>
  <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
  <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ja">Tweet</a>
    <article>
    <header>
      <h1>HerokuでClojureアプリをCompojureを使ってデプロイしてみよう その1</h1>
      <time datetime="2012-03-22" pubdate>Mar 22, 2012</time>
    </header>
    <p>Hi, 今日はいい天気だったね！みんな元気にしてるかな？</p>

<p>さて、今日は<a href="/blog/2012/03/17/clojure-leiningen-vimclojure.html">前回</a>インストールしたClojureを使って、実際に<a href="http://www.heroku.com/">Heroku</a>でアプリをデプロイしてみましょう。</p>

<p>Hello Worldアプリでもいいかと思ったんですが、さすがに簡単すぎるしチュートリアルも巷に溢れかえってるので少しだけ難易度を上げてPostgresqlを使ったアプリを開発してみることにします。</p>

<p>とりあえず、教材に使うアプリは<a href="http://guchitter.herokuapp.com/">これ</a>にします。テキストエリアに愚痴を入力して送信すると愚痴が表示されるという、Twitter超簡易版アプリ・「ぐちってー」です。Twitter Bootstrapとか勉強しながら作ってたら丸一日かかってしまいました。</p>

<p>ソースコードは<a href="https://github.com/k2nr/guchitter">こちら</a>です。</p>

<h2 id="目的">目的</h2>

<ul>
<li>Clojureを使った開発を実際に経験してみる</li>
<li>Compojureを使ったWebアプリの基本を学ぶ</li>
<li>Clojureで(JDBCドライバを使用した)Postgresqlを使用する方法を学ぶ</li>
<li>HerokuでClojureアプリを運用する方法を学ぶ</li>
</ul>

<p>少し長くなるので、数回に分けて連載方式でいこうと思います。</p>

<h2 id="登場人物の説明">登場人物の説明</h2>

<p>たくさんのフレームワークやライブラリが登場するので、簡単に紹介しておきます。</p>

<h3 id="compojure">Compojure</h3>

<p>Clojureで今もっとも広く使われているであろうWebフレームワークです。ルーティングなどが楽に実装できます。すごくシンプルな作りになってて、初学者が混乱することは少ないだろうと思います。その他のWebフレームワークにNoirなどありますが、今回は登場しません。使い方わからないし。</p>

<h3 id="ring">Ring</h3>

<p>Clojureで作られたWebアプリケーションライブラリです。CompojureはこのRingをベースにして開発されています。Compojureでは実装されていない機能などはRingのAPIを使用します。</p>

<h3 id="hiccup">Hiccup</h3>

<p>いわゆるHTMLテンプレートエンジンです。Hiccupの他にもEnlive,Fleetというエンジンがありますが、Hiccupが最もシンプルなので今回はこれを使います。</p>

<h3 id="postgresql">Postgresql</h3>

<p>ご存知リレーショナルデータベース管理システムの雄。postgresを選んだ理由はただ一つ、HerokuではPostgresしか使えないからです。
今回はローカルでpostgresqlサーバーを動かして開発するのでインストールされてない方はインストールしておきましょう。</p>
<pre class="highlight plaintext"><code>brew install postgresql
</code></pre>

<h3 id="heroku">Heroku</h3>

<p>Webアプリホスティングサービスですね。Paasって言うんでしょうか。最近のバズワード難しくてわかりません＞＜</p>

<p>HerokuでClojureが運用できるということで、どうしても試してみたくなったというのが今回の連載の動機です。</p>

<h2 id="project-clj">project.clj</h2>

<p>依存ライブラリは<code>project.clj</code>に書きます。特に難しい話は無いのでコピペすればいいじゃない！</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="nf">defproject</span><span class="w"> </span><span class="n">guchitter</span><span class="w"> </span><span class="s">"1.0.0-SNAPSHOT"</span><span class="w">
  </span><span class="no">:description</span><span class="w"> </span><span class="s">"guchitter"</span><span class="w">
  </span><span class="no">:dependencies</span><span class="w"> </span><span class="p">[[</span><span class="n">org.clojure/clojure</span><span class="w"> </span><span class="s">"1.3.0"</span><span class="p">]</span><span class="w">
                 </span><span class="p">[</span><span class="n">org.clojure/clojure-contrib</span><span class="w"> </span><span class="s">"1.2.0"</span><span class="p">]</span><span class="w">
                 </span><span class="p">[</span><span class="n">postgresql</span><span class="w"> </span><span class="s">"9.1-901.jdbc4"</span><span class="p">]</span><span class="w">
                 </span><span class="p">[</span><span class="n">org.clojure/java.jdbc</span><span class="w"> </span><span class="s">"0.1.1"</span><span class="p">]</span><span class="w">
                 </span><span class="p">[</span><span class="n">compojure</span><span class="w"> </span><span class="s">"1.0.1"</span><span class="p">]</span><span class="w">
                 </span><span class="p">[</span><span class="n">hiccup</span><span class="w"> </span><span class="s">"0.3.8"</span><span class="p">]</span><span class="w">
                 </span><span class="p">[</span><span class="n">ring/ring-jetty-adapter</span><span class="w"> </span><span class="s">"1.1.0-SNAPSHOT"</span><span class="p">]</span><span class="w">
                 </span><span class="p">[</span><span class="n">ring/ring-devel</span><span class="w"> </span><span class="s">"1.1.0-SNAPSHOT"</span><span class="p">]</span><span class="w">
                </span><span class="p">]</span><span class="w">
  </span><span class="no">:main</span><span class="w"> </span><span class="n">guchitter.core</span><span class="p">)</span><span class="w">
</span></code></pre>

<p>ちなみに、ライブラリの検索、バージョンの確認には<a href="http://clojars.org/">Clojars</a>というサイトを使います。</p>

<h2 id="compojureのキホン">Compojureのキホン</h2>

<p>早速Compojureの使い方を見ていきましょう。
<code>src/guchitter/core.clj</code>は名前のとおりアプリの核となるベースの処理を書いています。</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">guchitter.core</span><span class="w">
  </span><span class="p">(</span><span class="no">:use</span><span class="w">
    </span><span class="p">[</span><span class="n">compojure.core</span><span class="w"> </span><span class="no">:only</span><span class="w"> </span><span class="p">[</span><span class="n">defroutes</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">compojure.route</span><span class="w"> </span><span class="no">:only</span><span class="w">  </span><span class="p">[</span><span class="n">not-found</span><span class="w"> </span><span class="n">files</span><span class="w"> </span><span class="n">resources</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.adapter.jetty</span><span class="w"> </span><span class="no">:only</span><span class="w"> </span><span class="p">[</span><span class="n">run-jetty</span><span class="p">]]</span><span class="w">
    </span><span class="p">[</span><span class="n">ring.middleware.reload</span><span class="p">]</span><span class="w">
    </span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="p">[</span><span class="n">compojure.handler</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">handler</span><span class="p">]</span><span class="w">
           </span><span class="p">[</span><span class="n">guchitter.views.layout</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">layout</span><span class="p">]</span><span class="w">
           </span><span class="p">[</span><span class="n">guchitter.controllers.guchi</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">controller</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="nf">defroutes</span><span class="w"> </span><span class="n">main-routes</span><span class="w">
  </span><span class="n">controller/routes</span><span class="w">
  </span><span class="p">(</span><span class="nf">files</span><span class="w"> </span><span class="s">"/"</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">resources</span><span class="w"> </span><span class="s">"/"</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">not-found</span><span class="w"> </span><span class="p">(</span><span class="nf">layout/not-found</span><span class="p">)))</span><span class="w"> </span><span class="c1">;not-foundを通すと文字化けする
</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="p">[</span><span class="n">port</span><span class="w"> </span><span class="n">app</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">run-jetty</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="p">{</span><span class="no">:port</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="no">:join?</span><span class="w"> </span><span class="n">false</span><span class="p">}))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">application</span><span class="w"> </span><span class="p">(</span><span class="nf">handler/site</span><span class="w"> </span><span class="n">main-routes</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">-main</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">port</span><span class="w"> </span><span class="p">(</span><span class="nf">Integer/parseInt</span><span class="w"> </span><span class="p">(</span><span class="nf">System/getenv</span><span class="w"> </span><span class="s">"PORT"</span><span class="p">))]</span><span class="w">
    </span><span class="p">(</span><span class="nf">start</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="n">application</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">-dev-main</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">dev-app</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">application</span><span class="w">
                  </span><span class="p">(</span><span class="nf">wrap-reload</span><span class="w"> </span><span class="o">'</span><span class="p">[</span><span class="n">guchitter.core</span><span class="w">
                                 </span><span class="n">guchitter.views</span><span class="w">
                                 </span><span class="n">guchitter.models</span><span class="w">
                                 </span><span class="n">guchitter.controllers</span><span class="p">]))</span><span class="w">
        </span><span class="n">port</span><span class="w"> </span><span class="mi">8080</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">start</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="n">dev-app</span><span class="p">)))</span><span class="w">

</span></code></pre>

<p><code>ns</code>,<code>use</code>,<code>require</code>とかは他のサイトなどで使い方を確認しておいて下さい。</p>

<h3 id="defroutes">defroutes</h3>

<p><code>defroutes</code>マクロでルーティングを定義します。</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="nf">defroutes</span><span class="w"> </span><span class="n">main-routes</span><span class="w">
  </span><span class="n">controller/routes</span><span class="w">
  </span><span class="p">(</span><span class="nf">files</span><span class="w"> </span><span class="s">"/"</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">resources</span><span class="w"> </span><span class="s">"/"</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">not-found</span><span class="w"> </span><span class="p">(</span><span class="nf">layout/not-found</span><span class="p">)))</span><span class="w"> </span><span class="c1">;not-foundを通すと文字化けする
</span></code></pre>

<p>先頭の<code>controller/routes</code>は<code>controller/routes</code>のルーティングを参照することを示しています。該当のコードを引用すると
<code>clj
(defroutes routes
  (GET &quot;/&quot; [] (index))
  (POST &quot;/&quot; {params :params} (create params)))
</code></p>

<p>最初に、<code>/</code>にGETリクエストがきた場合、<code>index</code>関数が呼ばれて(<code>index</code>関数の詳細は後で登場します)、index関数は表示する完全なhtmlを返します。
同様に<code>/</code>にPOSTリクエストがきた場合、POSTのパラメータがparamsに入り、それをcreate関数に渡し、create関数は送られた愚痴をDBに登録した後にこのときに表示すべきHTMLを返します。(厳密にはウソです。実際にはHTMLではなく<code>/</code>にリダイレクトするHTTPのレスポンスを返します)</p>

<h3 id="静的ファイルの取り扱い">静的ファイルの取り扱い</h3>

<p><code>core.clj</code>に話を戻して、<code>(files &quot;/&quot;)</code>は何をしているかというと、静的なファイルの取り扱いを指定しています。この例では例えば<code>/A.html</code>のGETリクエストがきたときに<code>[プロジェクトのルート]/public/A.html</code>というファイルを返すことになります。</p>

<p><code>(resources &quot;/&quot;)</code>も同様なのですが、こちらはリソースファイルです。デフォルトでは<code>[プロジェクトのルート]/resources/public/</code>のファイルが該当します。</p>

<h3 id="存在しないurl">存在しないURL</h3>

<p><code>(not-found (layout/not-found))</code>の部分は404を表示する場合に<code>layout/not-found</code>関数の返すHTMLを表示します。コメントのとおり、<code>not-found</code>関数を通すと文字化けしてしまうようで、日本語が使えません。バグなのか使い方が悪いのか。。。</p>

<p>ひとつ注意点として、<code>not-found</code>は<code>defroutes</code>の末尾に書かなければなりません。ルーティングの際には<code>defroutes</code>で定義された順に評価されるからです。</p>

<h2 id="サーバーの開始">サーバーの開始</h2>

<p><code>(run-jetty app {:port port :join? false}))</code>これでサーバー開始です。JettyというHTTPサーバが動き始めます。<code>:port</code>はポート番号、<code>:join?</code>はブロッキング・ノンブロッキングの指定です。</p>

<p>ポート番号を環境変数<code>PORT</code>から取得していますが、これはHerokuで動作させるためです。ローカルでは<code>PORT</code>環境変数は存在しないので、ローカルで動かす場合は環境変数を定義する必要があります。</p>
<pre class="highlight plaintext"><code>export PORT=8080
</code></pre>

<h2 id="実際に動かしてみよう">実際に動かしてみよう</h2>

<p>全部のファイルについて解説したわけじゃないですが、第一回の締めにここで一旦動かしてみましょう。動かすためにはまずDBを作成しなきゃなりません。</p>

<h3 id="dbの作成">DBの作成</h3>
<pre class="highlight plaintext"><code>$ initdb pg
$ postgres -D pg &amp;
$ createdb guchi
$ export PORT=8080
$ export DATABASE_URL=postgres://localhost:5432/guchi
</code></pre>

<p>これでデータベースguchitterが作成されました。ちなみにHeroku上でデプロイする際は既に存在する共有DBを使用するので、DB作成は必要ありません。次にテーブルを作成します。</p>
<pre class="highlight plaintext"><code>$ lein run -m guchitter.models.migration
</code></pre>

<p>これで<code>guchi.models.migration/-main</code>関数が実行されます。<code>migration.clj</code>の解説は省略します。これはテーブルを作成するためのスクリプトです。コードは以下のとおり。</p>
<pre class="highlight clojure"><code><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">guchitter.models.migration</span><span class="w">
  </span><span class="p">(</span><span class="no">:use</span><span class="w"> </span><span class="p">[</span><span class="n">guchitter.models.db</span><span class="w"> </span><span class="no">:only</span><span class="w"> </span><span class="p">[</span><span class="n">my-db</span><span class="p">]])</span><span class="w">
  </span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.java.jdbc</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">sql</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">create-guchi</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">sql/with-connection</span><span class="w"> </span><span class="n">my-db</span><span class="w">
    </span><span class="p">(</span><span class="nf">sql/create-table</span><span class="w"> </span><span class="no">:guchi</span><span class="w">
      </span><span class="p">[</span><span class="no">:id</span><span class="w"> </span><span class="no">:serial</span><span class="w"> </span><span class="s">"PRIMARY KEY"</span><span class="p">]</span><span class="w">
      </span><span class="p">[</span><span class="no">:body</span><span class="w"> </span><span class="no">:varchar</span><span class="w"> </span><span class="s">"NOT NULL"</span><span class="p">]</span><span class="w">
      </span><span class="p">[</span><span class="no">:created_at</span><span class="w"> </span><span class="no">:timestamp</span><span class="w"> </span><span class="s">"NOT NULL"</span><span class="w"> </span><span class="s">"DEFAULT CURRENT_TIMESTAMP"</span><span class="p">])))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">-main</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nb">print</span><span class="w"> </span><span class="s">"Migrating database..."</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">flush</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nf">create-guchi</span><span class="p">)</span><span class="w">
  </span><span class="p">(</span><span class="nb">println</span><span class="w"> </span><span class="s">" done"</span><span class="p">))</span><span class="w">
</span></code></pre>

<p>migrationで使用されているSQL関連は次回解説しますね。</p>

<h3 id="サーバー起動">サーバー起動</h3>

<p>1行実行するだけ。</p>
<pre class="highlight plaintext"><code>$ lein run
</code></pre>

<p>動きましたか？</p>

<p>続きはまた次回にしましょう。</p>

<h2 id="最後に">最後に</h2>

<p>最後に感謝の意を述べなければなりません。前回のエントリで乞食をしたところ、早速2人の方から品物が届きました。</p>

<p>こんなどうしようもないニートのためにお金を使ってくれる人がいるなんて、涙が出るほど嬉しいです。ほんとにありがとうございます。</p>

<p><img src="https://lh6.googleusercontent.com/-O5Nm5MJ_mL0/T2sbNxGXUQI/AAAAAAAAB6g/g5U58Z2ggPQ/s640/CameraZOOM-20120321191940267.jpg" /></p>

<p><img src="https://lh6.googleusercontent.com/-vLZhXTZVNzg/T2sbOpWcBmI/AAAAAAAAB6o/n85ZLzzOYnQ/s640/CameraZOOM-20120322194904594.jpg" /></p>

<p>もしまだ寄付してもいいよ！という人がいれば<a href="http://www.amazon.co.jp/registry/wishlist/3RAOAVXS8DJUV">こちら</a>から商品を送ってくだしあ！！！</p>

<h2 id="参考サイト">参考サイト</h2>

<ul>
<li><a href="http://devcenter.heroku.com/articles/clojure-web-application">Building a Database-Backed Clojure Web Application | Heroku Dev Center</a></li>
</ul>

  </article>
  
  <div id="disqus_thread"></div>
  <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'k2nrme'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  <footer>
  k2nr
</footer>

  </body>
</html>
